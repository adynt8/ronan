<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Z4Q23E9QXZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-Z4Q23E9QXZ');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlsSize.Me - Shared Penis Size Results</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.21.0"></script>
</head>
<body>
    <div class="container">
        <h1>PlsSize.Me - Shared Penis Size Results</h1>
        <div id="results"></div>
        <div id="size-comparison"></div>
        <div id="pornstar-comparison"></div>
        <a href="index.html" class="button">Back to Calculator</a>
    </div>

    <script>
        const SUPABASE_URL = 'https://lcayhsjrmjkwxekutiih.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxjYXloc2pybWprd3hla3V0aWloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjUzMjQzNjMsImV4cCI6MjA0MDkwMDM2M30.HO8ykfrFvwxjhFt5XuDJ1aMvbbIRpnvYO4n18NqXqLc';
        
        // Initialize Supabase client
        let supabaseClient;

        // Copy necessary data and functions from index.html
        const stats = {cm: {erectLength: { avg: 13.12, stdDev: 2.66 }, flaccidLength: { avg: 9.16, stdDev: 1.57 }, erectGirth: { avg: 11.66, stdDev: 1.10 }, flaccidGirth: { avg: 9.31, stdDev: 0.90 }}, in: {erectLength: { avg: 5.17, stdDev: 1.05 }, flaccidLength: { avg: 3.61, stdDev: 0.62 }, erectGirth: { avg: 4.59, stdDev: 0.43 }, flaccidGirth: { avg: 3.67, stdDev: 0.35 }}};
        const objectComparisons = {cm: [{ name: "AA battery", length: 5.0 }, { name: "Banana", length: 18.0 }, { name: "iPhone 12", length: 14.6 }, { name: "Soda can", length: 12.2 }, { name: "Credit card", length: 8.5 }, { name: "Golf ball", length: 4.3 }, { name: "Toothbrush", length: 19.0 }, { name: "Pencil", length: 19.0 }, { name: "Cucumber", length: 20.0 }, { name: "Remote control", length: 15.0 }, { name: "Hotdog", length: 15.2 }, { name: "Carrot", length: 16.0 }, { name: "Eggplant", length: 21.0 }, { name: "Corn on the cob", length: 17.8 }, { name: "Zucchini", length: 20.3 }], in: [{ name: "AA battery", length: 1.97 }, { name: "Banana", length: 7.09 }, { name: "iPhone 12", length: 5.75 }, { name: "Soda can", length: 4.80 }, { name: "Credit card", length: 3.35 }, { name: "Golf ball", length: 1.69 }, { name: "Toothbrush", length: 7.48 }, { name: "Pencil", length: 7.48 }, { name: "Cucumber", length: 7.87 }, { name: "Remote control", length: 5.91 }, { name: "Hotdog", length: 5.98 }, { name: "Carrot", length: 6.30 }, { name: "Eggplant", length: 8.27 }, { name: "Corn on the cob", length: 7.01 }, { name: "Zucchini", length: 7.99 }]};
        const pornstarComparisons = {cm: [{ name: "Lexington Steele", length: 24.13 }, { name: "Mandingo", length: 23.40 }, { name: "Rocco Siffredi", length: 23.00 }, { name: "Danny D", length: 22.86 }, { name: "Julio Gomez", length: 23.89 }, { name: "Criss Strokes", length: 22.86 }, { name: "Manuel Ferrara", length: 21.59 }, { name: "Kieran Lee", length: 22.23 }, { name: "Vlad the Impaler", length: 23.50 }, { name: "Whitezilla", length: 23.13 }, { name: "Johnny Sins", length: 20.32 }, { name: "James Deen", length: 19.05 }, { name: "Keiran Lee", length: 22.86 }, { name: "Mick Blue", length: 20.32 }, { name: "Ramon Nomar", length: 21.59 }, { name: "Bruce Venture", length: 20.32 }, { name: "Jordi El Niño Polla", length: 17.78 }, { name: "Small Hands", length: 16.51 }, { name: "Xander Corvus", length: 18.42 }, { name: "Seth Gamble", length: 17.78 }, { name: "Mike Adriano", length: 16.51 }, { name: "Tommy Gunn", length: 15.24 }, { name: "Erik Everhard", length: 14.61 }, { name: "Markus Dupree", length: 13.97 }, { name: "Ricky Johnson", length: 13.34 }, { name: "Damon Dice", length: 12.70 }, { name: "Tyler Nixon", length: 12.07 }, { name: "Logan Pierce", length: 11.43 }, { name: "Alex D", length: 10.80 }, { name: "Chad White", length: 10.16 }, { name: "Brad Newman", length: 9.53 }], in: [{ name: "Lexington Steele", length: 9.5 }, { name: "Mandingo", length: 9.2 }, { name: "Rocco Siffredi", length: 9.0 }, { name: "Danny D", length: 9.0 }, { name: "Julio Gomez", length: 9.4 }, { name: "Criss Strokes", length: 9.0 }, { name: "Manuel Ferrara", length: 8.5 }, { name: "Kieran Lee", length: 8.75 }, { name: "Vlad the Impaler", length: 9.25 }, { name: "Whitezilla", length: 9.1 }, { name: "Johnny Sins", length: 8.0 }, { name: "James Deen", length: 7.5 }, { name: "Keiran Lee", length: 9.0 }, { name: "Mick Blue", length: 8.0 }, { name: "Ramon Nomar", length: 8.5 }, { name: "Bruce Venture", length: 8.0 }, { name: "Jordi El Niño Polla", length: 7.0 }, { name: "Small Hands", length: 6.5 }, { name: "Xander Corvus", length: 7.25 }, { name: "Seth Gamble", length: 7.0 }, { name: "Mike Adriano", length: 6.5 }, { name: "Tommy Gunn", length: 6.0 }, { name: "Erik Everhard", length: 5.75 }, { name: "Markus Dupree", length: 5.5 }, { name: "Ricky Johnson", length: 5.25 }, { name: "Damon Dice", length: 5.0 }, { name: "Tyler Nixon", length: 4.75 }, { name: "Logan Pierce", length: 4.5 }, { name: "Alex D", length: 4.25 }, { name: "Chad White", length: 4.0 }, { name: "Brad Newman", length: 3.75 }]};
        const femalePreferences = {cm: { avg: 16.0, stdDev: 2.5 }, in: { avg: 6.3, stdDev: 1.0 }};

        function calculatePercentile(value, mean, standardDeviation) {
            const zScore = (value - mean) / standardDeviation;
            return 100 * (0.5 * (1 + Math.erf(zScore / Math.sqrt(2))));
        }

        // Add erf function if not supported by browser
        if (!Math.erf) {
            Math.erf = function(x) {
                const t = 1 / (1 + 0.5 * Math.abs(x));
                const tau = t * Math.exp(-x * x - 1.26551223 + 
                            1.00002368 * t + 0.37409196 * t * t + 
                            0.09678418 * t * t * t - 
                            0.18628806 * t * t * t * t + 
                            0.27886807 * t * t * t * t * t - 
                            1.13520398 * t * t * t * t * t * t + 
                            1.48851587 * t * t * t * t * t * t * t - 
                            0.82215223 * t * t * t * t * t * t * t * t + 
                            0.17087277 * t * t * t * t * t * t * t * t * t);
                return x >= 0 ? 1 - tau : tau - 1;
            };
        }

        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        async function initSupabase() {
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        }

        async function fetchVisitorData(visitorId) {
            if (!supabaseClient) {
                await initSupabase();
            }
            try {
                const { data, error } = await supabaseClient
                    .from('visitor_data')
                    .select('*')
                    .eq('visitorId', visitorId)
                    .single();

                if (error) throw error;

                console.log('Fetched visitor data:', data);
                return data;
            } catch (error) {
                console.error('Error fetching visitor data:', error);
                return null;
            }
        }

        async function displaySharedResults() {
            const urlParams = new URLSearchParams(window.location.search);
            const encodedParams = urlParams.get('d');
            const visitorId = atob(encodedParams);

            console.log('Decoded visitor ID:', visitorId);

            const data = await fetchVisitorData(visitorId);

            if (!data) {
                console.error('No data found for visitor ID:', visitorId);
                return;
            }

            console.log('Fetched data for visitor ID:', data);

            const { unit, erectLength, flaccidLength, erectGirth, flaccidGirth } = data;

            const measurements = {
                erectLength: parseFloat(erectLength),
                flaccidLength: parseFloat(flaccidLength),
                erectGirth: parseFloat(erectGirth),
                flaccidGirth: parseFloat(flaccidGirth)
            };

            const result = document.getElementById('results');
            const comparison = document.getElementById('size-comparison');
            const pornstarComparison = document.getElementById('pornstar-comparison');

            let resultHTML = '';
            for (let [key, value] of Object.entries(measurements)) {
                if (!isNaN(value)) {
                    const { avg, stdDev } = stats[unit][key];
                    const percentile = calculatePercentile(value, avg, stdDev);
                    const difference = value - avg;
                    resultHTML += `<div class='result-box'>`;
                    resultHTML += `<h3>${capitalizeFirstLetter(key.replace(/([A-Z])/g, ' $1').toLowerCase())}</h3>`;
                    resultHTML += `<p>Measurement: ${value.toFixed(2)} ${unit}</p>`;
                    resultHTML += `<p>Percentile: ${percentile.toFixed(1)}%</p>`;
                    resultHTML += `<p>Difference from Average: ${Math.abs(difference).toFixed(2)} ${unit} ${difference >= 0 ? 'Above' : 'Below'}</p>`;
                    resultHTML += `</div>`;
                }
            }

            result.innerHTML = resultHTML;
            console.log('Displayed results:', resultHTML);

            // Update object size comparison
            let closestObject = objectComparisons[unit].reduce((prev, curr) => 
                Math.abs(curr.length - measurements.erectLength) < Math.abs(prev.length - measurements.erectLength) ? curr : prev
            );
            
            let comparisonHTML = '<div class="result-box"><h3>Most Relevant Size Comparison:</h3>';
            if (measurements.erectLength >= closestObject.length) {
                comparisonHTML += `<p>The Erect Length is Slightly Longer than a ${closestObject.name} (${closestObject.length} ${unit}).</p>`;
            } else {
                comparisonHTML += `<p>The Erect Length is Slightly Shorter than a ${closestObject.name} (${closestObject.length} ${unit}).</p>`;
            }
            comparisonHTML += '</div>';
            comparison.innerHTML = comparisonHTML;
            console.log('Displayed size comparison:', comparisonHTML);

            // Update pornstar comparisons
            let pornstarHTML = '<h3>Comparisons to Adult Film Actors:</h3>';
            let sortedPornstars = pornstarComparisons[unit].sort((a, b) => Math.abs(measurements.erectLength - a.length) - Math.abs(measurements.erectLength - b.length));
            sortedPornstars.slice(0, 4).forEach(star => {
                const difference = Math.abs(measurements.erectLength - star.length);
                pornstarHTML += `
                    <div class="pornstar-card">
                        <h4>${star.name}</h4>
                        <p>${star.length} ${unit}</p>
                        <p>${difference.toFixed(2)} ${unit} ${measurements.erectLength >= star.length ? 'Longer' : 'Shorter'}</p>
                    </div>
                `;
            });
            pornstarComparison.innerHTML = pornstarHTML;
            console.log('Displayed pornstar comparisons:', pornstarHTML);
        }

        document.addEventListener('DOMContentLoaded', function() {
            initSupabase().then(() => {
                displaySharedResults();
            });
        });
    </script>
</body>
</html>
